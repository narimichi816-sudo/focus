import trophyService from './TrophyService.js'
import acquiredTrophyService from './AcquiredTrophyService.js'
import todoService from './TodoService.js'
import { challengeStorage } from './StorageManager.js'

/**
 * ??????????????
 * ??????????????????????????????
 */
class TrophyChallengeService {
  /**
   * ??????????????YYYY-MM-DD???
   * @returns {string}
   */
  getTodayString() {
    const today = new Date()
    today.setHours(0, 0, 0, 0)
    return today.toISOString().split('T')[0]
  }

  /**
   * ???????????YYYY-MM-DD???
   * @param {string} dateStr1
   * @param {string} dateStr2
   * @returns {number} dateStr1 < dateStr2 ??????????????0??????????
   */
  compareDateStrings(dateStr1, dateStr2) {
    return new Date(dateStr1) - new Date(dateStr2)
  }

  /**
   * ??????????2?????????????
   * @param {string} dateStr - ??????YYYY-MM-DD?????ISO 8601???
   * @returns {boolean}
   */
  isAtLeastTwoDaysAgo(dateStr) {
    const today = new Date(this.getTodayString())
    const targetDate = new Date(dateStr.split('T')[0])
    const diffTime = today - targetDate
    const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24))
    return diffDays >= 2
  }

  /**
   * ?????????????????????
   * @returns {Object|null} { trophy: Trophy, date: string } ??? null
   */
  getTodayChallenge() {
    const today = this.getTodayString()
    const challenge = challengeStorage.get()

    // ?????????????????
    if (challenge && challenge.date === today) {
      return challenge
    }

    // ?????????????????????
    return this.generateTodayChallenge()
  }

  /**
   * ??????????????????
   * @returns {Object|null} { trophy: Trophy, date: string } ??? null
   */
  generateTodayChallenge() {
    const today = this.getTodayString()
    const allTrophies = trophyService.getAll()

    if (allTrophies.length === 0) {
      return null
    }

    // ?????????????
    const randomIndex = Math.floor(Math.random() * allTrophies.length)
    const selectedTrophy = allTrophies[randomIndex]

    const challenge = {
      trophy: selectedTrophy,
      date: today,
    }

    challengeStorage.save(challenge)
    return challenge
  }

  /**
   * ????????Todo????????
   * ??: ???2?????????????????????????
   * @returns {Array<TodoTask>}
   */
  getEligibleTasks() {
    const today = this.getTodayString()
    const allTasks = todoService.getAll()

    return allTasks.filter((task) => {
      // ???????????????
      if (!task.dueDate) {
        return false
      }
      const dueDateStr = task.dueDate.split('T')[0]
      if (dueDateStr !== today) {
        return false
      }

      // ???????2?????????????
      if (!this.isAtLeastTwoDaysAgo(task.createdAt)) {
        return false
      }

      return true
    })
  }

  /**
   * ????????????????????
   * @returns {Object} { isEligible: boolean, eligibleTasks: Array<TodoTask>, completedCount: number, totalCount: number }
   */
  checkAcquisitionCondition() {
    const eligibleTasks = this.getEligibleTasks()

    if (eligibleTasks.length === 0) {
      return {
        isEligible: false,
        eligibleTasks: [],
        completedCount: 0,
        totalCount: 0,
      }
    }

    const completedTasks = eligibleTasks.filter((task) => task.completed)
    const isEligible = completedTasks.length === eligibleTasks.length

    return {
      isEligible,
      eligibleTasks,
      completedCount: completedTasks.length,
      totalCount: eligibleTasks.length,
    }
  }

  /**
   * ??????????
   * @returns {Object|null} { acquiredTrophy: AcquiredTrophy, challenge: Object } ??? null
   */
  acquireTrophy() {
    const challenge = this.getTodayChallenge()

    if (!challenge) {
      return null
    }

    // ???????????
    if (acquiredTrophyService.isAcquired(challenge.trophy.id)) {
      return {
        acquiredTrophy: acquiredTrophyService.getByTrophyId(challenge.trophy.id),
        challenge,
      }
    }

    // ?????????
    const condition = this.checkAcquisitionCondition()
    if (!condition.isEligible) {
      return null
    }

    // ????????
    const acquiredTrophy = acquiredTrophyService.create({
      trophyId: challenge.trophy.id,
    })

    return {
      acquiredTrophy,
      challenge,
    }
  }

  /**
   * ????????????????????
   * ??????????????
   * @returns {void}
   */
  handleDateChange() {
    const today = this.getTodayString()
    const challenge = challengeStorage.get()

    // ?????????????????????
    if (challenge && challenge.date !== today) {
      // ??????????????????????????
      // ??????????????????????????????
      // ????????? getTodayChallenge() ????????
    }
  }

  /**
   * ????????????????????????
   * @returns {boolean}
   */
  isTodayChallengeAcquired() {
    const challenge = this.getTodayChallenge()
    if (!challenge) {
      return false
    }

    return acquiredTrophyService.isAcquired(challenge.trophy.id)
  }
}

export default new TrophyChallengeService()
